{% extends "admin/base.html" %}

{% block page_title %}Замовлення{% endblock %}

{% block content %}
<div x-data="ordersApp()" x-init="init()">
    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-tabs">
            <button class="filter-tab" :class="{ active: filter === 'all' }" @click="filter = 'all'">Всі</button>
            <button class="filter-tab" :class="{ active: filter === 'active' }" @click="filter = 'active'">Активні</button>
            <button class="filter-tab" :class="{ active: filter === 'completed' }" @click="filter = 'completed'">Завершені</button>
        </div>
        <div class="filter-actions">
            <!-- View Toggle -->
            <div class="view-toggle">
                <button class="view-btn" :class="{ active: viewMode === 'kanban' }" @click="viewMode = 'kanban'" title="Kanban">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M14,6H10V14H14M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M7,18V10H9V18H7M11,18V6H13V18H11M15,18V14H17V18H15Z"/></svg>
                </button>
                <button class="view-btn" :class="{ active: viewMode === 'table' }" @click="viewMode = 'table'" title="Таблиця">
                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M3,4H21V8H3V4M3,10H21V14H3V10M3,16H21V20H3V16Z"/></svg>
                </button>
            </div>
            <button class="btn btn-primary" @click="loadOrders()">
                <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/></svg>
                Оновити
            </button>
        </div>
    </div>

    <!-- Kanban View -->
    <div class="kanban-board" x-show="viewMode === 'kanban'">
        <template x-for="status in ['new', 'preparing', 'ready']" :key="status">
            <div class="kanban-column">
                <div class="column-header" :class="'status-' + status">
                    <span class="status-dot"></span>
                    <h3 x-text="getStatusText(status)"></h3>
                    <span class="count" x-text="getOrdersByStatus(status).length"></span>
                </div>
                <div class="column-content"
                     :class="{ 'drag-over': dragOverStatus === status }"
                     @dragover.prevent="handleDragOver($event, status)"
                     @dragleave="handleDragLeave($event)"
                     @drop="handleDrop($event, status)">
                    <template x-for="order in getOrdersByStatus(status)" :key="order._id">
                        <div class="kanban-card" :class="['status-' + order.status, draggingId === order._id ? 'dragging' : '']"
                             draggable="true"
                             @dragstart="handleDragStart($event, order)"
                             @dragend="handleDragEnd($event)">
                            <div class="card-header">
                                <span class="order-number" x-text="order.order_number"></span>
                                <span class="order-time" x-text="getTimeAgo(order.created_at)"></span>
                            </div>
                            <div class="card-type">
                                <span class="type-badge" :class="'type-' + order.order_type" x-text="getOrderType(order.order_type)"></span>
                                <span x-show="order.table_number" class="table-num" x-text="'Стіл ' + order.table_number"></span>
                            </div>
                            <div class="card-items">
                                <template x-for="item in order.items.slice(0, 3)" :key="item.product_id">
                                    <div class="item-line">
                                        <span class="qty" x-text="item.qty + 'x'"></span>
                                        <span x-text="item.name"></span>
                                    </div>
                                </template>
                                <div class="more-items" x-show="order.items.length > 3" x-text="'+ ще ' + (order.items.length - 3)"></div>
                            </div>
                            <div class="card-footer">
                                <span class="total" x-text="order.total + ' грн'"></span>
                                <span class="payment-badge" :class="order.payment_status" x-text="order.payment_status === 'paid' ? 'Оплачено' : 'Не оплачено'"></span>
                            </div>
                            <div class="card-actions">
                                <button class="action-btn details" @click="showDetails(order)" title="Деталі">
                                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/></svg>
                                </button>
                                <button class="action-btn next" @click="moveToNext(order)" x-show="status !== 'ready'" title="Далі">
                                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z"/></svg>
                                </button>
                                <button class="action-btn complete" @click="updateStatus(order._id, 'completed')" x-show="status === 'ready'" title="Завершити">
                                    <svg viewBox="0 0 24 24"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>
                                </button>
                            </div>
                        </div>
                    </template>
                    <div class="column-empty" x-show="getOrdersByStatus(status).length === 0">
                        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3"/></svg>
                        <span>Немає замовлень</span>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Table View -->
    <div class="card" x-show="viewMode === 'table'">
        <div class="table-wrapper">
            <table class="table" x-show="filteredOrders.length > 0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Статус</th>
                        <th>Оплата</th>
                        <th>Тип</th>
                        <th>Дата</th>
                        <th>Сума</th>
                        <th>Дії</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="order in filteredOrders" :key="order._id">
                        <tr>
                            <td x-text="order.order_number"></td>
                            <td>
                                <select class="status-select" :class="'status-' + order.status" @change="updateStatus(order._id, $event.target.value)" :value="order.status">
                                    <option value="new">Новий</option>
                                    <option value="preparing">Готується</option>
                                    <option value="ready">Готовий</option>
                                    <option value="completed">Завершено</option>
                                    <option value="cancelled">Скасовано</option>
                                </select>
                            </td>
                            <td>
                                <span class="badge" :class="order.payment_status === 'paid' ? 'badge-paid' : 'badge-pending'" x-text="order.payment_status === 'paid' ? 'Оплачено' : 'Очікує'"></span>
                            </td>
                            <td x-text="getOrderType(order.order_type)"></td>
                            <td x-text="formatDate(order.created_at)"></td>
                            <td><strong x-text="order.total + ' грн'"></strong></td>
                            <td>
                                <button class="btn-icon" @click="showDetails(order)" title="Деталі">
                                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/></svg>
                                </button>
                                <button class="btn-icon" @click="markPaid(order._id)" x-show="order.payment_status !== 'paid'" title="Позначити оплаченим">
                                    <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M21,18V19A2,2 0 0,1 19,21H5C3.89,21 3,20.1 3,19V5A2,2 0 0,1 5,3H19A2,2 0 0,1 21,5V6H12C10.89,6 10,6.9 10,8V16A2,2 0 0,0 12,18M12,16H22V8H12M16,13.5A1.5,1.5 0 0,1 14.5,12A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 17.5,12A1.5,1.5 0 0,1 16,13.5Z"/></svg>
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div class="empty-state" x-show="filteredOrders.length === 0">
            <div class="empty-icon">
                <svg viewBox="0 0 24 24" width="80" height="80"><path fill="#dfe6e9" d="M19,3H14.82C14.4,1.84 13.3,1 12,1C10.7,1 9.6,1.84 9.18,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M12,3A1,1 0 0,1 13,4A1,1 0 0,1 12,5A1,1 0 0,1 11,4A1,1 0 0,1 12,3"/></svg>
            </div>
            <h3>Тут поки немає замовлень</h3>
            <p>Замовлення з'являться після їх створення</p>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal" x-show="showModal" x-transition @click.self="showModal = false">
        <div class="modal-content" x-show="selectedOrder">
            <div class="modal-header">
                <h3 x-text="'Замовлення ' + (selectedOrder?.order_number || '')"></h3>
                <button @click="showModal = false">&times;</button>
            </div>
            <div class="modal-body">
                <div class="order-meta">
                    <p><strong>Статус:</strong> <span x-text="getStatusText(selectedOrder?.status)"></span></p>
                    <p><strong>Тип:</strong> <span x-text="getOrderType(selectedOrder?.order_type)"></span></p>
                    <p x-show="selectedOrder?.table_number"><strong>Стіл:</strong> <span x-text="selectedOrder?.table_number"></span></p>
                    <p x-show="selectedOrder?.customer_name"><strong>Клієнт:</strong> <span x-text="selectedOrder?.customer_name"></span></p>
                    <p x-show="selectedOrder?.notes"><strong>Примітка:</strong> <span x-text="selectedOrder?.notes"></span></p>
                </div>

                <h4>Товари:</h4>
                <div class="order-items">
                    <template x-for="item in selectedOrder?.items || []" :key="item.product_id">
                        <div class="order-item">
                            <span x-text="item.name"></span>
                            <span x-text="item.qty + ' x ' + item.price + ' грн'"></span>
                        </div>
                    </template>
                </div>

                <div class="order-total">
                    <strong>Всього: <span x-text="(selectedOrder?.total || 0) + ' грн'"></span></strong>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* View Toggle */
.filter-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}

.view-toggle {
    display: flex;
    background: var(--color-bg-body);
    border-radius: 8px;
    padding: 4px;
}

.view-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
    transition: all 0.2s;
}

.view-btn:hover {
    color: var(--color-text-primary);
}

.view-btn.active {
    background: var(--color-bg-card);
    color: var(--color-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Kanban Board */
.kanban-board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-top: 20px;
}

.kanban-column {
    background: var(--color-bg-body);
    border-radius: 12px;
    min-height: 500px;
    display: flex;
    flex-direction: column;
}

.column-header {
    padding: 15px 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.column-header.status-new {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
}

.column-header.status-preparing {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
}

.column-header.status-ready {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
}

[data-theme="dark"] .column-header.status-new {
    background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
}

[data-theme="dark"] .column-header.status-preparing {
    background: linear-gradient(135deg, #e65100 0%, #ef6c00 100%);
}

[data-theme="dark"] .column-header.status-ready {
    background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
}

.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: currentColor;
}

.status-new .status-dot { background: #2196F3; }
.status-preparing .status-dot { background: #FF9800; }
.status-ready .status-dot { background: #4CAF50; }

.column-header h3 {
    flex: 1;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-primary);
}

.column-header .count {
    background: rgba(0,0,0,0.1);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.column-content {
    flex: 1;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;
}

/* Kanban Card */
.kanban-card {
    background: var(--color-bg-card);
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: transform 0.2s, box-shadow 0.2s;
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.12);
}

/* Drag and Drop styles */
.kanban-card {
    cursor: grab;
}

.kanban-card:active {
    cursor: grabbing;
}

.kanban-card.dragging {
    opacity: 0.5;
    transform: scale(0.98);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.column-content.drag-over {
    background: var(--color-primary-light);
    border: 2px dashed var(--color-primary);
    border-radius: 8px;
}

[data-theme="dark"] .column-content.drag-over {
    background: rgba(99, 102, 241, 0.1);
}

.kanban-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.kanban-card .order-number {
    font-weight: 700;
    color: var(--color-text-primary);
}

.kanban-card .order-time {
    font-size: 0.8rem;
    color: var(--color-text-muted);
}

.kanban-card .card-type {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}

.type-badge {
    font-size: 0.75rem;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: 500;
}

.type-dine_in { background: #e3f2fd; color: #1976D2; }
.type-takeaway { background: #f3e5f5; color: #7B1FA2; }
.type-delivery { background: #fce4ec; color: #C2185B; }

[data-theme="dark"] .type-dine_in { background: #1a237e; color: #90caf9; }
[data-theme="dark"] .type-takeaway { background: #4a148c; color: #ce93d8; }
[data-theme="dark"] .type-delivery { background: #880e4f; color: #f48fb1; }

.table-num {
    font-size: 0.8rem;
    color: var(--color-text-secondary);
}

.kanban-card .card-items {
    border-top: 1px dashed var(--color-border);
    padding-top: 10px;
    margin-bottom: 10px;
}

.item-line {
    display: flex;
    gap: 8px;
    font-size: 0.9rem;
    padding: 3px 0;
    color: var(--color-text-secondary);
}

.item-line .qty {
    font-weight: 600;
    color: var(--color-primary);
    min-width: 25px;
}

.more-items {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    font-style: italic;
}

.kanban-card .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid var(--color-border-light);
}

.kanban-card .total {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--color-primary);
}

.payment-badge {
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: 500;
}

.payment-badge.paid { background: #e8f5e9; color: #2e7d32; }
.payment-badge.pending { background: #fff3e0; color: #f57c00; }

[data-theme="dark"] .payment-badge.paid { background: #1b5e20; color: #a5d6a7; }
[data-theme="dark"] .payment-badge.pending { background: #e65100; color: #ffcc80; }

.kanban-card .card-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.action-btn {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.action-btn svg {
    width: 18px;
    height: 18px;
}

.action-btn.details {
    background: var(--color-bg-body);
    color: var(--color-text-secondary);
}

.action-btn.details:hover {
    background: var(--color-border);
}

.action-btn.next {
    background: var(--color-primary-light);
    color: var(--color-primary);
}

.action-btn.next:hover {
    background: var(--color-primary);
    color: white;
}

.action-btn.complete {
    background: #e8f5e9;
    color: #2e7d32;
}

.action-btn.complete:hover {
    background: #4CAF50;
    color: white;
}

.column-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    color: var(--color-text-muted);
}

.column-empty svg {
    width: 50px;
    height: 50px;
    margin-bottom: 10px;
    opacity: 0.5;
}

/* Responsive */
@media (max-width: 1024px) {
    .kanban-board {
        grid-template-columns: 1fr;
    }

    .kanban-column {
        min-height: 300px;
    }
}
</style>

<script>
function ordersApp() {
    return {
        orders: [],
        filter: 'all',
        viewMode: localStorage.getItem('ordersViewMode') || 'kanban',
        showModal: false,
        selectedOrder: null,
        ws: null,
        draggingId: null,
        dragOverStatus: null,

        async init() {
            await this.loadOrders();
            this.connectWebSocket();

            // Save view preference
            this.$watch('viewMode', val => localStorage.setItem('ordersViewMode', val));
        },

        async loadOrders() {
            try {
                const response = await fetch('/api/orders');
                this.orders = await response.json();
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        },

        connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            this.ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            this.ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'new_order') {
                        this.orders.unshift(data.order);
                    } else if (data.type === 'order_updated') {
                        const order = this.orders.find(o => o._id === data.order_id);
                        if (order) order.status = data.status;
                    }
                } catch (e) {
                    // Ignore ping/pong
                }
            };

            this.ws.onclose = () => {
                setTimeout(() => this.connectWebSocket(), 3000);
            };
        },

        get filteredOrders() {
            if (this.filter === 'all') return this.orders;
            if (this.filter === 'active') return this.orders.filter(o => ['new', 'preparing', 'ready'].includes(o.status));
            if (this.filter === 'completed') return this.orders.filter(o => ['completed', 'cancelled'].includes(o.status));
            return this.orders;
        },

        getOrdersByStatus(status) {
            return this.orders.filter(o => o.status === status);
        },

        async updateStatus(orderId, status) {
            try {
                await fetch(`/api/orders/${orderId}/status?status=${status}`, { method: 'PUT' });
                const order = this.orders.find(o => o._id === orderId);
                if (order) order.status = status;
            } catch (error) {
                console.error('Error updating status:', error);
            }
        },

        moveToNext(order) {
            const flow = { 'new': 'preparing', 'preparing': 'ready' };
            const nextStatus = flow[order.status];
            if (nextStatus) {
                this.updateStatus(order._id, nextStatus);
            }
        },

        async markPaid(orderId) {
            try {
                await fetch(`/api/orders/${orderId}/payment?payment_status=paid`, { method: 'PUT' });
                const order = this.orders.find(o => o._id === orderId);
                if (order) order.payment_status = 'paid';
            } catch (error) {
                console.error('Error updating payment:', error);
            }
        },

        showDetails(order) {
            this.selectedOrder = order;
            this.showModal = true;
        },

        getStatusText(status) {
            const texts = { new: 'Нові', preparing: 'Готуються', ready: 'Готові', completed: 'Завершено', cancelled: 'Скасовано' };
            return texts[status] || status;
        },

        getOrderType(type) {
            const types = { dine_in: 'В залі', takeaway: 'З собою', delivery: 'Доставка' };
            return types[type] || type;
        },

        formatDate(dateStr) {
            return new Date(dateStr).toLocaleString('uk-UA');
        },

        getTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000 / 60); // minutes

            if (diff < 1) return 'щойно';
            if (diff < 60) return diff + ' хв';
            if (diff < 1440) return Math.floor(diff / 60) + ' год';
            return Math.floor(diff / 1440) + ' дн';
        },

        // Drag and Drop handlers
        handleDragStart(event, order) {
            this.draggingId = order._id;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', order._id);
        },

        handleDragEnd(event) {
            this.draggingId = null;
            this.dragOverStatus = null;
        },

        handleDragOver(event, status) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            this.dragOverStatus = status;
        },

        handleDragLeave(event) {
            if (!event.currentTarget.contains(event.relatedTarget)) {
                this.dragOverStatus = null;
            }
        },

        handleDrop(event, newStatus) {
            event.preventDefault();
            const orderId = event.dataTransfer.getData('text/plain');
            const order = this.orders.find(o => o._id === orderId);

            if (order && order.status !== newStatus) {
                this.updateStatus(orderId, newStatus);
            }

            this.draggingId = null;
            this.dragOverStatus = null;
        }
    };
}
</script>
{% endblock %}

{% extends "admin/base.html" %}

{% block page_title %}Асортимент{% endblock %}

{% block content %}
<div x-data="assortmentApp()" x-init="init()">
    <!-- Loading Overlay -->
    <div class="loading-overlay" x-show="loading" x-transition>
        <div class="spinner"></div>
        <span>Завантаження...</span>
    </div>

    <!-- Header -->
    <div class="page-header">
        <!-- Search -->
        <div class="search-container">
            <input type="text" class="form-input search-input" x-model="searchQuery"
                   @input.debounce.300ms="searchProducts()"
                   @keydown.escape="searchQuery = ''; searchResults = []"
                   @keydown.arrow-down.prevent="navigateSearch(1)"
                   @keydown.arrow-up.prevent="navigateSearch(-1)"
                   @keydown.enter.prevent="selectSearchResult()"
                   placeholder="Пошук страв... (до 20 результатів)">
            <div class="search-dropdown" x-show="searchResults.length > 0" @click.away="searchResults = []">
                <template x-for="(product, idx) in searchResults" :key="product._id">
                    <div class="search-result-item" :class="{ 'active': idx === selectedSearchIndex }"
                         @click="scrollToProduct(product._id)"
                         @mouseenter="selectedSearchIndex = idx">
                        <img :src="product.image" :alt="product.name" onerror="this.src='/static/img/placeholder.png'">
                        <div class="search-result-info">
                            <span class="name" x-text="product.name"></span>
                            <span class="category" x-text="getCategoryName(product.category_id)"></span>
                        </div>
                        <span class="price" x-text="product.price + ' грн'"></span>
                    </div>
                </template>
            </div>
        </div>

        <div class="header-actions">
            <!-- Select Mode Toggle -->
            <button class="btn" :class="selectMode ? 'btn-secondary' : 'btn-outline'"
                    @click="toggleSelectMode()">
                <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19M10,17L6,13L7.41,11.58L10,14.17L16.59,7.58L18,9"/></svg>
                <span x-text="selectMode ? 'Скасувати вибір' : 'Вибрати кілька'"></span>
            </button>

            <!-- Batch Actions (visible when items selected) -->
            <template x-if="selectMode && selectedProducts.length > 0">
                <div class="batch-actions">
                    <span class="selected-count" x-text="'Обрано: ' + selectedProducts.length"></span>
                    <button class="btn btn-success" @click="batchAddToMenu()">
                        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M12,3L1,9L12,15L21,10.09V17H23V9"/></svg>
                        В меню
                    </button>
                    <button class="btn btn-danger" @click="batchDelete()">
                        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                        Видалити
                    </button>
                </div>
            </template>

            <button class="btn btn-primary" @click="openModal()">
                <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
                Додати страву
            </button>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="products-grid">
        <template x-for="product in filteredProducts" :key="product._id">
            <div class="product-admin-card" :id="'product-' + product._id"
                 :class="{ 'selected': selectedProducts.includes(product._id) }">
                <!-- Select Checkbox -->
                <div class="select-checkbox" x-show="selectMode" @click.stop="toggleProductSelection(product._id)">
                    <input type="checkbox" :checked="selectedProducts.includes(product._id)">
                </div>
                <div class="product-image" @click="selectMode ? toggleProductSelection(product._id) : null">
                    <img :src="product.image" :alt="product.name" onerror="this.src='/static/img/placeholder.png'">
                    <span class="availability-badge" :class="product.available ? 'available' : 'unavailable'" x-text="product.available ? 'В наявності' : 'Немає'"></span>
                    <span class="menu-badge" x-show="isInMenu(product._id)" title="Додано в меню">
                        <svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>
                    </span>
                    <!-- Weight Badge -->
                    <span class="weight-badge" x-show="product.weight" x-text="product.weight"></span>
                </div>
                <div class="product-details">
                    <h3 x-text="product.name"></h3>
                    <p class="category" x-text="getCategoryName(product.category_id)"></p>
                    <p class="price" x-text="product.price + ' грн'"></p>
                    <p class="modifiers-count" x-show="product.modifier_groups && product.modifier_groups.length > 0">
                        <svg viewBox="0 0 24 24" width="14" height="14"><path fill="currentColor" d="M3,17V19H9V17H3M3,5V7H13V5H3M13,21V19H21V17H13V15H11V21H13M7,9V11H3V13H7V15H9V9H7M21,13V11H11V13H21M15,9H17V7H21V5H17V3H15V9Z"/></svg>
                        <span x-text="product.modifier_groups.length + ' модиф.'"></span>
                    </p>
                </div>
                <div class="product-actions" x-show="!selectMode">
                    <button class="btn-icon" :class="isInMenu(product._id) ? 'success' : ''"
                            @click="toggleMenu(product)"
                            :title="isInMenu(product._id) ? 'Прибрати з меню' : 'Додати в меню'">
                        <svg x-show="!isInMenu(product._id)" viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M12,3L1,9L12,15L21,10.09V17H23V9M5,13.18V17.18L12,21L19,17.18V13.18L12,17L5,13.18Z"/></svg>
                        <svg x-show="isInMenu(product._id)" viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg>
                    </button>
                    <button class="btn-icon" @click="copyProduct(product)" title="Копіювати">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg>
                    </button>
                    <button class="btn-icon" @click="editProduct(product)" title="Редагувати">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/></svg>
                    </button>
                    <button class="btn-icon danger" @click="deleteProduct(product._id)" title="Видалити">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty State -->
    <div class="empty-state" x-show="products.length === 0">
        <h3>Асортимент порожній</h3>
        <p>Створіть першу страву в каталозі</p>
    </div>

    <!-- Product Modal -->
    <div class="modal" x-show="showModal" x-transition @click.self="showModal = false">
        <div class="modal-content modal-form">
            <div class="modal-header">
                <h3 x-text="editingProduct ? 'Редагувати страву' : 'Нова страва'"></h3>
                <button @click="showModal = false">&times;</button>
            </div>
            <form @submit.prevent="saveProduct()">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Назва</label>
                        <input type="text" class="form-input" x-model="form.name" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Категорія</label>
                            <select class="form-select" x-model="form.category_id" required>
                                <template x-for="cat in categories" :key="cat._id">
                                    <option :value="cat._id" x-text="cat.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ціна (грн)</label>
                            <input type="number" step="0.01" class="form-input" x-model="form.price" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Опис</label>
                        <textarea class="form-input" rows="3" x-model="form.description"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Вага/Об'єм</label>
                            <input type="text" class="form-input" x-model="form.weight" placeholder="250 мл">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Час приготування</label>
                            <input type="text" class="form-input" x-model="form.cook_time" placeholder="10 хв">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Денна норма виробництва</label>
                            <input type="number" class="form-input" x-model="form.daily_production_norm" placeholder="30" min="0">
                            <small style="color: var(--color-text-muted);">Залиште порожнім якщо не потрібно відстежувати</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">URL зображення</label>
                            <input type="text" class="form-input" x-model="form.image" placeholder="/static/img/product.jpg">
                        </div>
                    </div>

                    <!-- Tags Section -->
                    <div class="form-group" x-show="productTags.length > 0">
                        <label class="form-label">Теги</label>
                        <div class="tags-select" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <template x-for="tag in productTags" :key="tag._id">
                                <label class="tag-checkbox" :style="'border-color: ' + tag.color + '; ' + (form.tags.includes(tag._id) ? 'background-color: ' + tag.color + '; color: white;' : '')">
                                    <input type="checkbox"
                                           :value="tag._id"
                                           :checked="form.tags.includes(tag._id)"
                                           @change="toggleTag(tag._id)"
                                           style="display: none;">
                                    <span x-text="tag.name"></span>
                                </label>
                            </template>
                        </div>
                    </div>

                    <!-- Modifiers Section -->
                    <div class="form-group" x-show="modifiers.length > 0">
                        <label class="form-label">Модифікатори</label>
                        <div class="modifiers-select">
                            <template x-for="mod in modifiers" :key="mod._id">
                                <label class="checkbox-label modifier-item">
                                    <input type="checkbox"
                                           :value="mod._id"
                                           :checked="form.modifier_groups.includes(mod._id)"
                                           @change="toggleModifier(mod._id)">
                                    <span x-text="mod.name"></span>
                                    <small x-text="'(' + mod.options.length + ' опцій)'"></small>
                                </label>
                            </template>
                        </div>
                    </div>

                    <div class="form-group" style="display: flex; gap: 30px;">
                        <label class="checkbox-label">
                            <input type="checkbox" x-model="form.available">
                            <span>В наявності</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" x-model="form.is_alcohol">
                            <span>Містить алкоголь</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" @click="showModal = false">Скасувати</button>
                    <button type="submit" class="btn btn-primary" x-text="editingProduct ? 'Зберегти' : 'Додати'"></button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 15px;
    z-index: 9999;
    color: white;
    font-size: 1.1rem;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Search */
.search-container {
    position: relative;
    flex: 1;
    max-width: 400px;
}

.search-input {
    width: 100%;
    padding-left: 40px !important;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'%3E%3Cpath fill='%23999' d='M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: 12px center;
}

.search-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 100;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    margin-top: 4px;
}

.search-result-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--color-border);
    transition: background 0.2s;
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-item:hover,
.search-result-item.active {
    background: var(--color-primary-light);
}

.search-result-item img {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    object-fit: cover;
}

.search-result-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.search-result-info .name {
    font-weight: 500;
    color: var(--color-text-primary);
}

.search-result-info .category {
    font-size: 0.8rem;
    color: var(--color-text-muted);
}

.search-result-item .price {
    font-weight: 600;
    color: var(--color-primary);
}

/* Header Actions */
.page-header {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-left: auto;
}

.batch-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 8px 15px;
    background: var(--color-primary-light);
    border-radius: 8px;
}

.selected-count {
    font-weight: 500;
    color: var(--color-primary);
}

/* Select Mode */
.select-checkbox {
    position: absolute;
    top: 8px;
    left: 8px;
    z-index: 10;
    width: 24px;
    height: 24px;
    background: white;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.select-checkbox input {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.product-admin-card {
    position: relative;
    transition: all 0.2s;
}

.product-admin-card.selected {
    outline: 3px solid var(--color-primary);
    transform: scale(0.98);
}

/* Weight Badge */
.weight-badge {
    position: absolute;
    bottom: 8px;
    left: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
}

/* Existing Styles */
.menu-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: var(--success);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modifiers-count {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 4px;
}

.modifiers-select {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    max-height: 150px;
    overflow-y: auto;
}

.tag-checkbox {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border: 2px solid var(--border-color);
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
}

.tag-checkbox:hover {
    opacity: 0.8;
}

.modifier-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.modifier-item small {
    color: var(--text-secondary);
}

.btn-icon.success {
    color: var(--success);
}

/* Highlight animation for search */
.product-admin-card.highlight {
    animation: highlightPulse 2s ease-out;
}

@keyframes highlightPulse {
    0% { box-shadow: 0 0 0 4px var(--color-primary); }
    100% { box-shadow: none; }
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: stretch;
    }
    .search-container {
        max-width: 100%;
    }
    .header-actions {
        margin-left: 0;
        flex-wrap: wrap;
    }
}
</style>

<script>
const categoriesData = {{ categories | tojson }};

function assortmentApp() {
    return {
        products: [],
        categories: categoriesData || [],
        modifiers: [],
        productTags: [],
        menuItems: [],
        showModal: false,
        editingProduct: null,
        loading: false,

        // Search
        searchQuery: '',
        searchResults: [],
        selectedSearchIndex: -1,

        // Select Mode
        selectMode: false,
        selectedProducts: [],

        form: {
            name: '',
            category_id: '',
            price: 0,
            description: '',
            image: '/static/img/placeholder.svg',
            weight: '',
            cook_time: '',
            available: true,
            modifier_groups: [],
            daily_production_norm: null,
            tags: [],
            is_alcohol: false
        },

        // Computed: filtered products for display
        get filteredProducts() {
            return this.products;
        },

        async init() {
            this.loading = true;
            try {
                await Promise.all([
                    this.loadProducts(),
                    this.loadModifiers(),
                    this.loadMenuItems(),
                    this.loadProductTags()
                ]);
                if (this.categories.length > 0) {
                    this.form.category_id = this.categories[0]._id;
                }
            } finally {
                this.loading = false;
            }
        },

        async loadProducts() {
            try {
                const response = await fetch('/api/products');
                this.products = await response.json();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        },

        // ========== SEARCH ==========
        searchProducts() {
            if (this.searchQuery.length < 2) {
                this.searchResults = [];
                this.selectedSearchIndex = -1;
                return;
            }
            const q = this.searchQuery.toLowerCase();
            this.searchResults = this.products.filter(p =>
                p.name.toLowerCase().includes(q) ||
                this.getCategoryName(p.category_id).toLowerCase().includes(q)
            ).slice(0, 20); // Max 20 results
            this.selectedSearchIndex = this.searchResults.length > 0 ? 0 : -1;
        },

        navigateSearch(direction) {
            if (this.searchResults.length === 0) return;
            this.selectedSearchIndex = Math.max(0, Math.min(
                this.selectedSearchIndex + direction,
                this.searchResults.length - 1
            ));
        },

        selectSearchResult() {
            if (this.selectedSearchIndex >= 0 && this.searchResults[this.selectedSearchIndex]) {
                this.scrollToProduct(this.searchResults[this.selectedSearchIndex]._id);
            }
        },

        scrollToProduct(productId) {
            this.searchResults = [];
            this.searchQuery = '';
            const element = document.getElementById('product-' + productId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.classList.add('highlight');
                setTimeout(() => element.classList.remove('highlight'), 2000);
            }
        },

        // ========== SELECT MODE ==========
        toggleSelectMode() {
            this.selectMode = !this.selectMode;
            if (!this.selectMode) {
                this.selectedProducts = [];
            }
        },

        toggleProductSelection(productId) {
            const idx = this.selectedProducts.indexOf(productId);
            if (idx === -1) {
                this.selectedProducts.push(productId);
            } else {
                this.selectedProducts.splice(idx, 1);
            }
        },

        async batchAddToMenu() {
            if (this.selectedProducts.length === 0) return;
            this.loading = true;
            try {
                for (const productId of this.selectedProducts) {
                    if (!this.isInMenu(productId)) {
                        await fetch('/api/menu-items', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                product_id: productId,
                                is_active: true,
                                sort_order: 0
                            })
                        });
                    }
                }
                await this.loadMenuItems();
                this.selectedProducts = [];
                this.selectMode = false;
            } finally {
                this.loading = false;
            }
        },

        async batchDelete() {
            if (this.selectedProducts.length === 0) return;
            if (!confirm(`Видалити ${this.selectedProducts.length} страв?`)) return;

            this.loading = true;
            try {
                for (const productId of this.selectedProducts) {
                    // Remove from menu if exists
                    if (this.isInMenu(productId)) {
                        const menuItemId = this.getMenuItemId(productId);
                        if (menuItemId) {
                            await fetch(`/api/menu-items/${menuItemId}`, { method: 'DELETE' });
                        }
                    }
                    await fetch(`/api/products/${productId}`, { method: 'DELETE' });
                }
                await this.loadProducts();
                await this.loadMenuItems();
                this.selectedProducts = [];
                this.selectMode = false;
            } finally {
                this.loading = false;
            }
        },

        // ========== COPY ==========
        async copyProduct(product) {
            if (!confirm(`Копіювати "${product.name}"?`)) return;

            this.loading = true;
            try {
                const response = await fetch(`/api/products/${product._id}/copy`, {
                    method: 'POST'
                });
                if (response.ok) {
                    await this.loadProducts();
                } else {
                    alert('Помилка копіювання');
                }
            } catch (error) {
                console.error('Error copying product:', error);
                alert('Помилка копіювання');
            } finally {
                this.loading = false;
            }
        },

        async loadModifiers() {
            try {
                const response = await fetch('/api/modifiers');
                this.modifiers = await response.json();
            } catch (error) {
                console.error('Error loading modifiers:', error);
            }
        },

        async loadMenuItems() {
            try {
                const response = await fetch('/api/menu-items?active_only=false');
                this.menuItems = await response.json();
            } catch (error) {
                console.error('Error loading menu items:', error);
            }
        },

        async loadProductTags() {
            try {
                const response = await fetch('/api/product-tags');
                this.productTags = await response.json();
            } catch (error) {
                console.error('Error loading product tags:', error);
            }
        },

        toggleTag(tagId) {
            const index = this.form.tags.indexOf(tagId);
            if (index === -1) {
                this.form.tags.push(tagId);
            } else {
                this.form.tags.splice(index, 1);
            }
        },

        getCategoryName(catId) {
            const cat = this.categories.find(c => c._id === catId);
            return cat ? cat.name : '';
        },

        isInMenu(productId) {
            return this.menuItems.some(item => item._id === productId || item.product_id === productId);
        },

        getMenuItemId(productId) {
            const item = this.menuItems.find(item => item._id === productId || item.product_id === productId);
            return item ? (item.menu_item_id || item._id) : null;
        },

        async toggleMenu(product) {
            const scrollPos = window.scrollY; // Save scroll position
            try {
                if (this.isInMenu(product._id)) {
                    // Remove from menu
                    const menuItemId = this.getMenuItemId(product._id);
                    if (menuItemId) {
                        await fetch(`/api/menu-items/${menuItemId}`, { method: 'DELETE' });
                    }
                } else {
                    // Add to menu
                    await fetch('/api/menu-items', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            product_id: product._id,
                            is_active: true,
                            sort_order: 0
                        })
                    });
                }
                await this.loadMenuItems();
                // Restore scroll position
                this.$nextTick(() => window.scrollTo(0, scrollPos));
            } catch (error) {
                console.error('Error toggling menu:', error);
            }
        },

        toggleModifier(modId) {
            const idx = this.form.modifier_groups.indexOf(modId);
            if (idx > -1) {
                this.form.modifier_groups.splice(idx, 1);
            } else {
                this.form.modifier_groups.push(modId);
            }
        },

        openModal() {
            this.editingProduct = null;
            this.form = {
                name: '',
                category_id: this.categories[0]?._id || '',
                price: 0,
                description: '',
                image: '/static/img/placeholder.svg',
                weight: '',
                cook_time: '',
                available: true,
                modifier_groups: [],
                daily_production_norm: null,
                tags: [],
                is_alcohol: false
            };
            this.showModal = true;
        },

        editProduct(product) {
            this.editingProduct = product;
            this.form = {
                ...product,
                modifier_groups: product.modifier_groups || [],
                tags: product.tags || [],
                daily_production_norm: product.daily_production_norm || null,
                is_alcohol: product.is_alcohol || false
            };
            this.showModal = true;
        },

        async saveProduct() {
            try {
                const url = this.editingProduct
                    ? `/api/products/${this.editingProduct._id}`
                    : '/api/products';
                const method = this.editingProduct ? 'PUT' : 'POST';

                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.form)
                });

                this.showModal = false;
                await this.loadProducts();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        },

        async deleteProduct(productId) {
            if (!confirm('Видалити цю страву з асортименту?')) return;

            try {
                // Also remove from menu if exists
                if (this.isInMenu(productId)) {
                    const menuItemId = this.getMenuItemId(productId);
                    if (menuItemId) {
                        await fetch(`/api/menu-items/${menuItemId}`, { method: 'DELETE' });
                    }
                }

                await fetch(`/api/products/${productId}`, { method: 'DELETE' });
                await this.loadProducts();
                await this.loadMenuItems();
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        }
    };
}
</script>
{% endblock %}

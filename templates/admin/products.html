{% extends "admin/base.html" %}

{% block page_title %}Управління меню{% endblock %}

{% block content %}
<div x-data="productsApp()" x-init="init()">
    <!-- Header -->
    <div class="page-header">
        <button class="btn btn-primary" @click="openModal()">
            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
            Додати товар
        </button>
    </div>

    <!-- Products Grid -->
    <div class="products-grid">
        <template x-for="product in products" :key="product._id">
            <div class="product-admin-card">
                <div class="product-image">
                    <img :src="product.image" :alt="product.name" onerror="this.src='/static/img/placeholder.png'">
                    <span class="availability-badge" :class="product.available ? 'available' : 'unavailable'" x-text="product.available ? 'В наявності' : 'Немає'"></span>
                </div>
                <div class="product-details">
                    <h3 x-text="product.name"></h3>
                    <p class="category" x-text="getCategoryName(product.category_id)"></p>
                    <p class="price" x-text="product.price + ' грн'"></p>
                </div>
                <div class="product-actions">
                    <button class="btn-icon" @click="editProduct(product)" title="Редагувати">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/></svg>
                    </button>
                    <button class="btn-icon danger" @click="deleteProduct(product._id)" title="Видалити">
                        <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty State -->
    <div class="empty-state" x-show="products.length === 0">
        <h3>Товари відсутні</h3>
        <p>Додайте перший товар до меню</p>
    </div>

    <!-- Product Modal -->
    <div class="modal" x-show="showModal" x-transition @click.self="showModal = false">
        <div class="modal-content modal-form">
            <div class="modal-header">
                <h3 x-text="editingProduct ? 'Редагувати товар' : 'Новий товар'"></h3>
                <button @click="showModal = false">&times;</button>
            </div>
            <form @submit.prevent="saveProduct()">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Назва</label>
                        <input type="text" class="form-input" x-model="form.name" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Категорія</label>
                            <select class="form-select" x-model="form.category_id" required>
                                <template x-for="cat in categories" :key="cat._id">
                                    <option :value="cat._id" x-text="cat.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ціна (грн)</label>
                            <input type="number" step="0.01" class="form-input" x-model="form.price" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Опис</label>
                        <textarea class="form-input" rows="3" x-model="form.description"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Вага/Об'єм</label>
                            <input type="text" class="form-input" x-model="form.weight" placeholder="250 мл">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Час приготування</label>
                            <input type="text" class="form-input" x-model="form.cook_time" placeholder="10 хв">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL зображення</label>
                        <input type="text" class="form-input" x-model="form.image" placeholder="/static/img/product.jpg">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" x-model="form.available">
                            <span>В наявності</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" @click="showModal = false">Скасувати</button>
                    <button type="submit" class="btn btn-primary" x-text="editingProduct ? 'Зберегти' : 'Додати'"></button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
const categoriesData = {{ categories | tojson }};

function productsApp() {
    return {
        products: [],
        categories: categoriesData || [],
        showModal: false,
        editingProduct: null,
        form: {
            name: '',
            category_id: '',
            price: 0,
            description: '',
            image: '/static/img/placeholder.png',
            weight: '',
            cook_time: '',
            available: true
        },

        async init() {
            await this.loadProducts();
            if (this.categories.length > 0) {
                this.form.category_id = this.categories[0]._id;
            }
        },

        async loadProducts() {
            try {
                const response = await fetch('/api/products');
                this.products = await response.json();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        },

        getCategoryName(catId) {
            const cat = this.categories.find(c => c._id === catId);
            return cat ? cat.name : '';
        },

        openModal() {
            this.editingProduct = null;
            this.form = {
                name: '',
                category_id: this.categories[0]?._id || '',
                price: 0,
                description: '',
                image: '/static/img/placeholder.svg',
                weight: '',
                cook_time: '',
                available: true
            };
            this.showModal = true;
        },

        editProduct(product) {
            this.editingProduct = product;
            this.form = { ...product };
            this.showModal = true;
        },

        async saveProduct() {
            try {
                const url = this.editingProduct
                    ? `/api/products/${this.editingProduct._id}`
                    : '/api/products';
                const method = this.editingProduct ? 'PUT' : 'POST';

                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.form)
                });

                this.showModal = false;
                await this.loadProducts();
            } catch (error) {
                console.error('Error saving product:', error);
            }
        },

        async deleteProduct(productId) {
            if (!confirm('Видалити цей товар?')) return;

            try {
                await fetch(`/api/products/${productId}`, { method: 'DELETE' });
                await this.loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
            }
        }
    };
}
</script>
{% endblock %}

{% extends "admin/base.html" %}

{% block page_title %}Комбо-набори{% endblock %}

{% block extra_css %}
<style>
.combos-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.combos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}

.combo-card {
    background: var(--color-bg-card);
    border-radius: 16px;
    overflow: hidden;
    border: 2px solid var(--color-border);
    transition: all 0.2s;
}

.combo-card:hover {
    border-color: var(--color-primary);
}

.combo-card.unavailable {
    opacity: 0.6;
}

.combo-image {
    height: 150px;
    background: var(--color-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.combo-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.combo-body {
    padding: 20px;
}

.combo-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--color-text-primary);
    margin-bottom: 10px;
}

.combo-description {
    font-size: 0.9rem;
    color: var(--color-text-muted);
    margin-bottom: 15px;
}

.combo-items {
    margin-bottom: 15px;
    padding: 15px;
    background: var(--color-bg);
    border-radius: 10px;
}

.combo-items h4 {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-bottom: 10px;
    text-transform: uppercase;
}

.combo-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 0.9rem;
}

.combo-item .qty {
    color: var(--color-text-muted);
}

.combo-pricing {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.regular-price {
    text-decoration: line-through;
    color: var(--color-text-muted);
    font-size: 1rem;
}

.combo-price {
    font-size: 1.5rem;
    font-weight: 700;
    color: #4CAF50;
}

.savings {
    background: #e8f5e9;
    color: #2e7d32;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.combo-actions {
    display: flex;
    gap: 10px;
}

.combo-actions button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-edit {
    background: var(--color-primary-light);
    color: var(--color-primary);
}

.btn-edit:hover {
    background: var(--color-primary);
    color: white;
}

.btn-toggle {
    background: #fff3e0;
    color: #ff9800;
}

.btn-toggle:hover {
    background: #ff9800;
    color: white;
}

.btn-delete {
    background: #ffebee;
    color: #f44336;
}

.btn-delete:hover {
    background: #f44336;
    color: white;
}

/* Modal */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--color-bg-card);
    border-radius: 16px;
    padding: 30px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.modal-header h2 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-muted);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-bg);
    color: var(--color-text-primary);
    font-size: 1rem;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.items-section h4 {
    margin-bottom: 15px;
}

.item-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
}

.item-row select {
    flex: 2;
    padding: 10px;
}

.item-row input {
    width: 70px;
    padding: 10px;
    text-align: center;
}

.item-row .remove-item {
    background: #ffebee;
    color: #f44336;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    cursor: pointer;
}

.btn-add-item {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    padding: 10px;
    background: var(--color-bg);
    border: 2px dashed var(--color-border);
    border-radius: 8px;
    color: var(--color-text-secondary);
    cursor: pointer;
    width: 100%;
}

.btn-add-item:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.btn-primary {
    width: 100%;
    padding: 14px;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
}

.btn-primary:hover {
    background: var(--color-primary-dark);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--color-text-muted);
}

.empty-state svg {
    width: 80px;
    height: 80px;
    opacity: 0.3;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<div x-data="combosApp()" x-init="init()">
    <!-- Header -->
    <div class="combos-header">
        <div>
            <p style="color: var(--color-text-muted); margin: 0;">
                Комбо-набори - вигідні пропозиції з кількох продуктів
            </p>
        </div>
        <button class="btn-add" @click="openModal()">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
            Створити комбо
        </button>
    </div>

    <!-- Combos Grid -->
    <div class="combos-grid" x-show="combos.length > 0">
        <template x-for="combo in combos" :key="combo._id">
            <div class="combo-card" :class="{ 'unavailable': !combo.available }">
                <div class="combo-image">
                    <img :src="combo.image || '/static/img/placeholder.svg'" :alt="combo.name">
                </div>
                <div class="combo-body">
                    <div class="combo-name" x-text="combo.name"></div>
                    <div class="combo-description" x-text="combo.description"></div>

                    <div class="combo-items">
                        <h4>Склад набору:</h4>
                        <template x-for="item in combo.items" :key="item.product_id">
                            <div class="combo-item">
                                <span x-text="item.product_name"></span>
                                <span class="qty" x-text="'x' + item.qty"></span>
                            </div>
                        </template>
                    </div>

                    <div class="combo-pricing">
                        <span class="regular-price" x-text="combo.regular_price + ' грн'"></span>
                        <span class="combo-price" x-text="combo.combo_price + ' грн'"></span>
                        <span class="savings" x-text="'-' + Math.round((combo.regular_price - combo.combo_price) / combo.regular_price * 100) + '%'"></span>
                    </div>

                    <div class="combo-actions">
                        <button class="btn-edit" @click="editCombo(combo)">Редагувати</button>
                        <button class="btn-toggle" @click="toggleCombo(combo)" x-text="combo.available ? 'Вимкнути' : 'Увімкнути'"></button>
                        <button class="btn-delete" @click="deleteCombo(combo._id)">Видалити</button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty State -->
    <div class="empty-state" x-show="combos.length === 0">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,17V16H9V14H13V13H11A2,2 0 0,1 9,11V10A2,2 0 0,1 11,8H12V7H14V8H15V10H11V11H13A2,2 0 0,1 15,13V14A2,2 0 0,1 13,16H12V17H11Z"/></svg>
        <h3>Немає комбо-наборів</h3>
        <p>Створіть вигідну пропозицію для клієнтів</p>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" x-show="showModal" x-transition.opacity @click.self="showModal = false" style="display: none;">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h2 x-text="editingCombo ? 'Редагувати комбо' : 'Нове комбо'"></h2>
                <button class="modal-close" @click="showModal = false">&times;</button>
            </div>

            <form @submit.prevent="saveCombo()">
                <div class="form-group">
                    <label>Назва</label>
                    <input type="text" x-model="form.name" required placeholder="Сніданок вихідного дня">
                </div>

                <div class="form-group">
                    <label>Опис</label>
                    <textarea x-model="form.description" rows="2" placeholder="Опис комбо..."></textarea>
                </div>

                <div class="form-group">
                    <label>Зображення (URL)</label>
                    <input type="text" x-model="form.image" placeholder="/static/img/combo.jpg">
                </div>

                <div class="items-section">
                    <h4>Продукти в комбо</h4>
                    <template x-for="(item, index) in form.items" :key="index">
                        <div class="item-row">
                            <select x-model="item.product_id" @change="updateItemName(index)" required>
                                <option value="">Оберіть продукт</option>
                                <template x-for="product in products" :key="product._id">
                                    <option :value="product._id" x-text="product.name + ' - ' + product.price + ' грн'"></option>
                                </template>
                            </select>
                            <input type="number" x-model="item.qty" min="1" placeholder="К-сть">
                            <button type="button" class="remove-item" @click="removeItem(index)" x-show="form.items.length > 1">&times;</button>
                        </div>
                    </template>
                    <button type="button" class="btn-add-item" @click="addItem()">
                        <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
                        Додати продукт
                    </button>
                </div>

                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label>Звичайна ціна</label>
                        <input type="number" x-model="form.regular_price" step="0.01" min="0" readonly :value="calculateRegularPrice()">
                    </div>
                    <div class="form-group">
                        <label>Ціна комбо</label>
                        <input type="number" x-model="form.combo_price" step="0.01" min="0" required placeholder="Вигідна ціна">
                    </div>
                </div>

                <button type="submit" class="btn-primary" style="margin-top: 10px;" x-text="editingCombo ? 'Зберегти' : 'Створити'"></button>
            </form>
        </div>
    </div>
</div>

<script>
function combosApp() {
    return {
        combos: [],
        products: [],
        showModal: false,
        editingCombo: null,
        form: {
            name: '',
            description: '',
            image: '',
            items: [{ product_id: '', product_name: '', qty: 1 }],
            regular_price: 0,
            combo_price: 0,
            available: true
        },

        async init() {
            await this.loadProducts();
            await this.loadCombos();
        },

        async loadProducts() {
            try {
                const response = await fetch('/api/products');
                this.products = await response.json();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        },

        async loadCombos() {
            try {
                const response = await fetch('/api/combos');
                this.combos = await response.json();
            } catch (error) {
                console.error('Error loading combos:', error);
            }
        },

        openModal(combo = null) {
            if (combo) {
                this.editingCombo = combo;
                this.form = {
                    name: combo.name,
                    description: combo.description || '',
                    image: combo.image || '',
                    items: combo.items.map(i => ({...i})),
                    regular_price: combo.regular_price,
                    combo_price: combo.combo_price,
                    available: combo.available
                };
            } else {
                this.editingCombo = null;
                this.form = {
                    name: '',
                    description: '',
                    image: '',
                    items: [{ product_id: '', product_name: '', qty: 1 }],
                    regular_price: 0,
                    combo_price: 0,
                    available: true
                };
            }
            this.showModal = true;
        },

        editCombo(combo) {
            this.openModal(combo);
        },

        addItem() {
            this.form.items.push({ product_id: '', product_name: '', qty: 1 });
        },

        removeItem(index) {
            this.form.items.splice(index, 1);
            this.calculateRegularPrice();
        },

        updateItemName(index) {
            const item = this.form.items[index];
            const product = this.products.find(p => p._id === item.product_id);
            if (product) {
                item.product_name = product.name;
            }
            this.calculateRegularPrice();
        },

        calculateRegularPrice() {
            let total = 0;
            for (const item of this.form.items) {
                const product = this.products.find(p => p._id === item.product_id);
                if (product) {
                    total += product.price * (parseInt(item.qty) || 1);
                }
            }
            this.form.regular_price = total;
            return total;
        },

        async saveCombo() {
            // Filter valid items
            const validItems = this.form.items.filter(item => item.product_id);
            if (validItems.length === 0) {
                alert('Додайте хоча б один продукт');
                return;
            }

            const data = {
                name: this.form.name,
                description: this.form.description,
                image: this.form.image || '/static/img/placeholder.svg',
                items: validItems.map(item => ({
                    product_id: item.product_id,
                    product_name: item.product_name,
                    qty: parseInt(item.qty) || 1
                })),
                regular_price: parseFloat(this.form.regular_price) || 0,
                combo_price: parseFloat(this.form.combo_price) || 0,
                available: this.form.available
            };

            try {
                const url = this.editingCombo
                    ? `/api/combos/${this.editingCombo._id}`
                    : '/api/combos';
                const method = this.editingCombo ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    this.showModal = false;
                    await this.loadCombos();
                } else {
                    alert('Помилка збереження');
                }
            } catch (error) {
                console.error('Error saving combo:', error);
                alert('Помилка збереження');
            }
        },

        async toggleCombo(combo) {
            try {
                const data = { ...combo, available: !combo.available };
                delete data._id;
                delete data.created_at;

                await fetch(`/api/combos/${combo._id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                await this.loadCombos();
            } catch (error) {
                console.error('Error toggling combo:', error);
            }
        },

        async deleteCombo(id) {
            if (!confirm('Видалити це комбо?')) return;

            try {
                await fetch(`/api/combos/${id}`, { method: 'DELETE' });
                await this.loadCombos();
            } catch (error) {
                console.error('Error deleting combo:', error);
            }
        }
    };
}
</script>
{% endblock %}

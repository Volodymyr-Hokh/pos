{% extends "admin/base.html" %}

{% block page_title %}Виробництво{% endblock %}

{% block extra_css %}
<style>
.production-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    flex-wrap: wrap;
    gap: 15px;
}

.category-filter {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.category-filter button {
    padding: 8px 16px;
    border: 2px solid var(--color-border);
    background: var(--color-bg-card);
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--color-text-secondary);
    transition: all 0.2s;
}

.category-filter button:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
}

.category-filter button.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
}

.production-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.production-card {
    background: var(--color-bg-card);
    border-radius: 16px;
    padding: 20px;
    border: 2px solid var(--color-border);
}

.production-card h4 {
    margin: 0 0 15px 0;
    color: var(--color-text-primary);
    font-size: 1.1rem;
}

.production-progress {
    margin-bottom: 10px;
}

.progress-bar {
    height: 24px;
    background: var(--color-bg);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}

.progress-fill {
    height: 100%;
    border-radius: 12px;
    transition: width 0.3s ease;
}

.progress-fill.green {
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
}

.progress-fill.yellow {
    background: linear-gradient(90deg, #FFC107, #FF9800);
}

.progress-fill.red {
    background: linear-gradient(90deg, #f44336, #E91E63);
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-weight: 600;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    font-size: 0.9rem;
}

.production-stats {
    display: flex;
    justify-content: space-between;
    color: var(--color-text-secondary);
    font-size: 0.9rem;
}

.stat-value {
    font-weight: 600;
    color: var(--color-text-primary);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--color-text-muted);
}

.empty-state svg {
    width: 80px;
    height: 80px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state h3 {
    margin-bottom: 10px;
    color: var(--color-text-secondary);
}

.refresh-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
}

.refresh-btn:hover {
    background: var(--color-primary-dark);
}

.refresh-btn svg {
    width: 18px;
    height: 18px;
}

.last-update {
    color: var(--color-text-muted);
    font-size: 0.85rem;
}
</style>
{% endblock %}

{% block content %}
<div x-data="productionApp()" x-init="init()">
    <div class="production-header">
        <div class="category-filter">
            <button :class="{ active: selectedCategory === null }" @click="selectedCategory = null; loadData()">Всі</button>
            <template x-for="cat in categories" :key="cat._id">
                <button :class="{ active: selectedCategory === cat._id }" @click="selectedCategory = cat._id; loadData()" x-text="cat.name"></button>
            </template>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span class="last-update" x-show="lastUpdate" x-text="'Оновлено: ' + lastUpdate"></span>
            <button class="refresh-btn" @click="loadData()">
                <svg viewBox="0 0 24 24"><path fill="currentColor" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"/></svg>
                Оновити
            </button>
        </div>
    </div>

    <template x-if="products.length === 0 && !loading">
        <div class="empty-state">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,3A9,9 0 0,0 3,12H0L4,16L8,12H5A7,7 0 0,1 12,5A7,7 0 0,1 19,12A7,7 0 0,1 12,19C10.5,19 9.09,18.5 7.94,17.7L6.5,19.14C8.04,20.3 9.94,21 12,21A9,9 0 0,0 21,12A9,9 0 0,0 12,3M14,12A2,2 0 0,0 12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12Z"/></svg>
            <h3>Немає продуктів з денною нормою</h3>
            <p>Встановіть денну норму виробництва для страв у розділі "Асортимент"</p>
        </div>
    </template>

    <div class="production-grid" x-show="products.length > 0">
        <template x-for="product in products" :key="product._id">
            <div class="production-card">
                <h4 x-text="product.name"></h4>
                <div class="production-progress">
                    <div class="progress-bar">
                        <div class="progress-fill"
                             :class="getProgressClass(product.percentage)"
                             :style="'width: ' + Math.min(product.percentage, 100) + '%'">
                        </div>
                        <span class="progress-text" x-text="product.sold_today + ' / ' + product.norm"></span>
                    </div>
                </div>
                <div class="production-stats">
                    <span>Залишок: <span class="stat-value" x-text="product.remaining"></span></span>
                    <span>Виконано: <span class="stat-value" x-text="product.percentage + '%'"></span></span>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
const categoriesData = {{ categories | tojson }};

function productionApp() {
    return {
        categories: categoriesData || [],
        products: [],
        selectedCategory: null,
        loading: false,
        lastUpdate: null,
        refreshInterval: null,

        async init() {
            await this.loadData();
            // Auto-refresh every 30 seconds
            this.refreshInterval = setInterval(() => this.loadData(), 30000);
        },

        async loadData() {
            this.loading = true;
            try {
                let url = '/api/production-status';
                if (this.selectedCategory) {
                    url += '?category_id=' + this.selectedCategory;
                }
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    this.products = data.products || [];
                    this.lastUpdate = new Date().toLocaleTimeString('uk-UA');
                }
            } catch (error) {
                console.error('Error loading production status:', error);
            }
            this.loading = false;
        },

        getProgressClass(percentage) {
            if (percentage >= 100) return 'red';
            if (percentage >= 80) return 'yellow';
            return 'green';
        }
    };
}
</script>
{% endblock %}
